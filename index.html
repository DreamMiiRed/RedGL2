<html>

<head>
    <meta charset="UTF-8">
    <title>기초테스트</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi"
    />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script src="src/gl-matrix-min.js"></script>
    <script src="src/RedGL.js"></script>
    <script src="src/base/RedBaseContainer.js"></script>
    <script src="src/base/RedBaseObject3D.js"></script>
    <script src="src/geometry/RedBuffer.js"></script>
    <script src="src/geometry/RedGeometry.js"></script>
    <script src="src/material/RedMaterial.js"></script>
    <script src="src/material/RedColorMaterial.js"></script>

    <script src="src/object3D/RedMesh.js"></script>

    <script src="src/program/RedProgram.js"></script>
    <script src="src/program/RedSystemShaderCode.js"></script>
    <script src="src/program/RedShader.js"></script>
    <script src="src/renderer/RedRenderer.js"></script>
    <script src="src/RedView.js"></script>
    <script src="src/RedWorld.js"></script>
    <script src="src/RedScene.js"></script>
    <script src="src/RedCamera.js"></script>
</head>

<body>
    <canvas id="test" style="border: none;background:red"></canvas>
    <script>
        var t = document.getElementById('test')
        document.body.appendChild(t)
        RedGL(t, function (v) {
            var tGL;
            var tWorld, tScene2D, tScene3D, tCamera, tCamera2, tCamera3;
            var tRenderer;
            var self;
            self = this
            tGL = this.gl;
            this.world = tWorld = RedWorld();
            tScene3D = RedScene();
            tScene2D = RedScene();
            tCamera = RedCamera();
            tCamera2 = RedCamera();
            tCamera3 = RedCamera();
            tCamera.orthographic = true

            tRenderer = RedRenderer();
            tWorld.addView(RedView('test', tScene2D, tCamera));
            tWorld.addView(RedView('test2', tScene3D, tCamera2));
            tWorld.addView(RedView('test3', tScene3D, tCamera3));
            tWorld.addView(RedView('test4', tScene3D, tCamera3));
            RedView('test2').setSize('25%', '25%')
            RedView('test3').setSize('35%', '25%')
            RedView('test3').setLocation('50%', '50%')
            RedView('test4').setSize('10%', '25%')
            RedView('test4').setLocation('0%', '75%')


            var testMaterial, testMaterial2
            testMaterial = RedColorMaterial(this, '#555')
            testMaterial2 = RedMaterial(this)


            var interleaveData
            interleaveData = new Float32Array([
                0.0, 1.0, 0.0, 1.0, 0.0, 0.0, 1.0,
                -1.0, -1.0, 0.0, 0.0, 1.0, 0.0, 1.0,
                1.0, -1.0, 0.0, 0.0, 0.0, 1.0, 1.0
            ]);
            var indexData
            indexData = new Uint16Array([0, 1, 2])

            var testInterleaveBuffer
            var testIndexBuffer
            testInterleaveBuffer = RedBuffer(
                this,
                'testInterleaveBuffer',
                interleaveData,
                RedBuffer.ARRAY_BUFFER, [{
                    attributeKey: 'aVertexPosition',
                    size: 3,
                    normalize: false
                },
                {
                    attributeKey: 'aVertexColor',
                    size: 4,
                    normalize: false
                }
                ]
            )
            testIndexBuffer = RedBuffer(
                this,
                'testIndexBuffer',
                indexData,
                RedBuffer.ELEMENT_ARRAY_BUFFER
            )
            var geometry
            geometry = RedGeometry(testInterleaveBuffer, testIndexBuffer)

            var testMesh
            var i = 2500
            while (i--) {
                var t = (1500 > i) ? testMaterial : testMaterial2
                testMesh = RedMesh(geometry, t)
                testMesh.x = Math.random() * 50 - 25
                testMesh.y = Math.random() * 50 - 25
                testMesh.z = Math.random() * 50 - 25
                testMesh.rotationX = Math.random() * 360
                testMesh.rotationY = Math.random() * 360
                testMesh.rotationZ = Math.random() * 360
                tScene3D.addChild(testMesh)

            }
            i = 200
            while (i--) {
                var t = (100 > i) ? testMaterial : testMaterial2
                testMesh = RedMesh(geometry, t)
                testMesh.x = Math.random() * 1280
                testMesh.y = Math.random() * 768
                testMesh.scaleX = testMesh.scaleY = 50
                // testMesh.rotationX = Math.random() * 360
                // testMesh.rotationY = Math.random() * 360
                testMesh.rotationZ = Math.random() * 360
                tScene2D.addChild(testMesh)
            }

            var renderResult;
            renderResult = document.createElement('div')
            renderResult.style.cssText = 'position:absolute;top:0px;left:0px;color:#fff;font-size:12px'
            document.body.appendChild(renderResult)

            tRenderer.start(this, function (time) {
                testMaterial['floatTest'] = time
                interleaveData[0] = Math.sin(time / 1000) * 3
                interleaveData[2] = Math.cos(time / 1000) * 3
                // testInterleaveBuffer.updateData(interleaveData)
                i = tScene3D.children.length
                while (i--) {
                    testMesh = tScene3D.children[i]
                    testMesh.rotationX += 1 / 20
                    testMesh.rotationY += 1 / 20
                    testMesh.rotationZ += 1 / 20
                }
                i = tScene2D.children.length
                while (i--) {
                    testMesh = tScene2D.children[i]
                    
                    testMesh.rotationZ += 1 / 20
                }
                RedView('test2').setLocation(Math.cos(time / 1000) * 100 + 100, Math.sin(time / 1000) *
                    100 + 100)
             

                tCamera2.x = Math.sin(time / 3000) * 15
                tCamera2.y = Math.cos(time / 3000) * 15
                tCamera2.z = Math.cos(time / 1500) * 15
                tCamera2.lookAt(0, 0, 0)

                // tCamera3.x = Math.sin(time / 3000) 
                tCamera3.y = Math.cos(time / 3000)
                tCamera3.z = Math.cos(time / 1500) * 10
                tCamera3.lookAt(0, 0, 0)

                renderResult.innerHTML = ''
                for (var k in tRenderer['renderInfo']) {
                    // console.log(tRenderer['renderInfo'][k])
                    renderResult.innerHTML +=
                        'RedView : key - ' + tRenderer['renderInfo'][k]['key']
                        + ' : call - ' + tRenderer['renderInfo'][k]['call']
                        + ' : width - ' + tRenderer['renderInfo'][k]['width']
                        + ' : height - ' + tRenderer['renderInfo'][k]['height']
                        + ' : x - ' + tRenderer['renderInfo'][k]['x']
                        + ' : y - ' + tRenderer['renderInfo'][k]['y']
                        + '<br>'
                }
                renderResult.innerHTML += 'renderScale : ' + self.renderScale

            })

            console.log(tScene3D)
        })
    </script>
</body>

</html>