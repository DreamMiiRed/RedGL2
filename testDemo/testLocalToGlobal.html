<html>

<head>
    <meta charset="UTF-8">
    <title>testLocalToGlobal</title>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi"
    />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script src="../src/gl-matrix-min.js"></script>
    <script src="../src/RedGLUtil.js"></script>
    <script src="../src/RedGL.js"></script>

    <script src="../src/frameBuffer/RedFrameBuffer.js"></script>

    <script src="../src/base/RedDefinePropertyInfo.js"></script>
    <script src="../src/base/RedBaseObject3D.js"></script>
    <script src="../src/base/RedBaseContainer.js"></script>
    <script src="../src/base/RedBaseLight.js"></script>
    <script src="../src/base/RedBaseMaterial.js"></script>


    <script src="../src/geometry/RedBuffer.js"></script>
    <script src="../src/geometry/RedGeometry.js"></script>
    <script src="../src/geometry/RedInterleaveInfo.js"></script>

    <script src="../src/light/RedAmbientLight.js"></script>
    <script src="../src/light/RedDirectionalLight.js"></script>
    <script src="../src/light/RedPointLight.js"></script>

    <script src="../src/loader/JsonModelLoader.js"></script>
    <script src="../src/loader/obj/RedMTLLoader.js"></script>
    <script src="../src/loader/obj/RedOBJLoader.js"></script>


    <script src="../src/material/RedColorMaterial.js"></script>
    <script src="../src/material/RedColorPhongMaterial.js"></script>
    <script src="../src/material/RedColorPhongTextureMaterial.js"></script>
    <script src="../src/material/RedEnvironmentMaterial.js"></script>
    <script src="../src/material/RedBitmapMaterial.js"></script>
    <script src="../src/material/RedPointBitmapMaterial.js"></script>
    <script src="../src/material/RedStandardMaterial.js"></script>
    <script src="../src/material/RedVideoMaterial.js"></script>
    <script src="../src/material/system/RedGridMaterial.js"></script>
    <script src="../src/material/RedPointColorMaterial.js"></script>
    <script src="../src/material/system/RedSkyBoxMaterial.js"></script>
    <script src="../src/material/system/RedPostEffectMaterial.js"></script>

    <script src="../src/object3D/RedAxis.js"></script>
    <script src="../src/object3D/RedGrid.js"></script>
    <script src="../src/object3D/RedMesh.js"></script>
    <script src="../src/object3D/RedLine.js"></script>
    <script src="../src/object3D/RedSkyBox.js"></script>
    <script src="../src/object3D/RedSprite3D.js"></script>

    <script src="../src/particle/RedPointUnit.js"></script>
    <script src="../src/postEffect/RedPostEffectManager.js"></script>

    <script src="../src/postEffect/blur/RedPostEffect_Blur.js"></script>
    <script src="../src/postEffect/RedPostEffect_Convolution.js"></script>
    <script src="../src/postEffect/adjustments/RedPostEffect_Invert.js"></script>
    <script src="../src/postEffect/adjustments/RedPostEffect_Gray.js"></script>
    <script src="../src/postEffect/adjustments/RedPostEffect_HueSaturation.js"></script>
    <script src="../src/postEffect/adjustments/RedPostEffect_BrightnessContrast.js"></script>
    <script src="../src/postEffect/RedPostEffect_Vignetting.js"></script>
    <script src="../src/postEffect/pixelate/RedPostEffect_Pixelize.js"></script>
    <script src="../src/postEffect/blur/RedPostEffect_ZoomBlur.js"></script>
    <script src="../src/postEffect/pixelate/RedPostEffect_HalfTone.js"></script>


    <script src="../src/primitives/RedBox.js"></script>
    <script src="../src/primitives/RedPlane.js"></script>
    <script src="../src/primitives/RedSphere.js"></script>

    <script src="../src/program/RedProgram.js"></script>
    <script src="../src/program/RedSystemShaderCode.js"></script>
    <script src="../src/program/RedShader.js"></script>

    <script src="../src/renderer/RedRenderer.js"></script>
    <script src="../src/renderer/system/RedRenderDebuger.js"></script>

    <script src="../src/resources/RedAtlas.js"></script>
    <script src="../src/resources/system/RedAtlasUV.js"></script>
    <script src="../src/resources/system/RedTextureOptionChecker.js"></script>
    <script src="../src/resources/RedBitmapTexture.js"></script>
    <script src="../src/resources/RedVideoTexture.js"></script>
    <script src="../src/resources/RedAtlasTexture.js"></script>
    <script src="../src/resources/RedBitmapCubeTexture.js"></script>

    <script src="../src/RedView.js"></script>
    <script src="../src/RedWorld.js"></script>
    <script src="../src/RedScene.js"></script>
    <script src="../src/camera/RedCamera.js"></script>
    <script src="../src/camera/RedBasicController.js"></script>
</head>

<body>
<canvas id="test" style="border: none;background:red"></canvas>
<script>
	var t = document.getElementById('test')
	document.body.appendChild(t)
	RedGL(t, function (v) {
		var tGL;
		var tWorld, tScene3D, tCamera
		var tRenderer;
		var self;
		self = this
		tGL = this.gl;
		this.world = tWorld = RedWorld();
		tScene3D = RedScene(this, '#00ff00');
		tCamera = RedCamera();
		tRenderer = RedRenderer();
		tWorld.addView(RedView('test', tScene3D, tCamera));
		RedView('test').setSize('100%', '100%')
		RedView('test').setLocation('0%', '0%')
		var testMaterial
		testMaterial = RedStandardMaterial(
			this,
			RedBitmapTexture(this, '../asset/crate.png')
		)
//		tScene3D.skyBox =
//			RedSkyBox(this, [
//				'../asset/cubemap/posx.png',
//				'../asset/cubemap/negx.png',
//				'../asset/cubemap/posy.png',
//				'../asset/cubemap/negy.png',
//				'../asset/cubemap/posz.png',
//				'../asset/cubemap/negz.png'
//			]);
		var testMesh, testMesh2, testMesh3, testMesh4
		testMesh = RedMesh(self, RedBox(self), testMaterial)
		testMesh.x = 1
		testMesh.y = 1
		testMesh.z = 1
		tScene3D.addChild(testMesh)
		testMesh2 = RedMesh(self, RedBox(self), testMaterial)
		testMesh2.x = -2
		testMesh.addChild(testMesh2)
		testMesh3 = RedMesh(self, RedBox(self), RedColorMaterial(self))
		testMesh3.scaleX = testMesh3.scaleY = testMesh3.scaleZ = 1.1
		tScene3D.addChild(testMesh3)
		testMesh4 = RedMesh(self, RedBox(self), RedColorMaterial(self, '#00ff00'))
		testMesh4.scaleX = testMesh4.scaleY = testMesh4.scaleZ = 1
		testMesh4.x = 2
		testMesh.addChild(testMesh4)
		var testMesh5
		JsonModelLoader(this, 'testJsonModel', '../asset/bunny.json', function (interleaveBuffer, indexBuffer) {
			testMesh5 = RedMesh(self, RedGeometry(interleaveBuffer, indexBuffer),
				RedColorPhongTextureMaterial(
					self
				))
			testMesh5.scaleX = testMesh5.scaleY = testMesh5.scaleZ = 0.3
			tScene3D.addChild(testMesh5)
			tScene3D['grid'] = RedGrid(self)
			// tScene3D['axis'] = RedAxis(self)
		})
		var testDLight, testALight;
		testDLight = RedDirectionalLight(this, '#fff')
		testDLight.x = 3
		testDLight.y = 3
		testDLight.z = 3
		tScene3D.addLight(testDLight)
		testALight = RedAmbientLight(this)
		tScene3D.addLight(testALight)
		var worldToScreenBox;
		worldToScreenBox = document.createElement('div')
		worldToScreenBox.style.cssText =
			'position:absolute;top:0px;left:0px;color:#fff;font-size:12px;background:rgba(0,0,0,0.6)'
		worldToScreenBox.innerHTML = 'worldToScreen Test'
		document.body.appendChild(worldToScreenBox)
		function get2dPoint(point3D, viewMatrix, projectionMatrix, width, height) {
			var viewProjectionMatrix = projectionMatrix * viewMatrix;
			//transform world to clipping coordinates

			point3D = projectionMatrix.multiply(point3D,);
			var winX = Math.round((( point3D[0] + 1 ) / 2.0) * width);
			//we calculate -point3D.getY() because the screen Y axis is
			//oriented top->down
			var winY = Math.round((( 1 - point3D[1] ) / 2.0) * height);
			return [winX, winY]
		}

		tRenderer.renderDebuger.visible = true
		tRenderer.start(this, function (time) {
			// testInterleaveBuffer.upload(interleaveData)
			// i = tScene3D.children.length
			// while (i--) {
			//     testMesh = tScene3D.children[i]
			//     testMesh.rotationX += 1
			//     testMesh.rotationY += 1
			//     testMesh.rotationZ += 1
			// }
			get2dPoint([testMesh.x, testMesh.y, testMesh.z], testMesh.matrix, tCamera.perspectiveMTX, self.gl.drawingBufferWidth, self.gl.drawingBufferHeight)
			testMesh.rotationX += 1
			testMesh.rotationY += 1
			testMesh.rotationZ += 1
			testMesh2.rotationX += 0.5
			testMesh2.rotationY += 0.5
			testMesh2.rotationZ += 0.5
			if ( testMesh5 ) {
				testMesh5.rotationX += 0.5
				testMesh5.rotationY += 0.5
				testMesh5.rotationZ += 0.5
			}
			// console.log(testMesh2.localToWorld(-2, 0, 0))
			testMesh3.x = testMesh2.localToWorld(-1, 1, 0)[0]
			testMesh3.y = testMesh2.localToWorld(-1, 1, 0)[1]
			testMesh3.z = testMesh2.localToWorld(-1, 1, 0)[2]
			testDLight.x = Math.sin(time / 1500) * 1
			testDLight.y = 5
			testDLight.z = Math.cos(time / 1500) * 1
			// console.log(testMesh4.worldToLocal(2, 2, 2))
			testMesh4.x = testMesh4.worldToLocal(3, 0, 1)[0]
			testMesh4.y = testMesh4.worldToLocal(3, 0, 1)[1]
			testMesh4.z = testMesh4.worldToLocal(3, 0, 1)[2]
			//   var testPosition = [Math.sin(time / 1500) * 5, 0, Math.cos(time / 1500) * 5]
			// testMesh4.x = testMesh4.worldToLocal(testPosition[0], testPosition[1], testPosition[2])[0]
			// testMesh4.y = testMesh4.worldToLocal(testPosition[0], testPosition[1], testPosition[2])[1]
			// testMesh4.z = testMesh4.worldToLocal(testPosition[0], testPosition[1], testPosition[2])[2]
			tCamera.y = 20
			tCamera.z = 50
			// tCamera.x = Math.sin(time / 1500) * 30
			// tCamera.y = Math.cos(time / 1500) * 30
			// if(tCamera.y<1) tCamera.y = 1
			// tCamera.z = Math.cos(time / 1500) * 30 + Math.sin(time / 1500) * 30
			tCamera.lookAt(0, 0, 0)
		})
		console.log(tScene3D)
	})
</script>
</body>

</html>