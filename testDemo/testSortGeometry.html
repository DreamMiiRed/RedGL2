<html>

<head>
    <meta charset="UTF-8">
    <title>testAutoProgram</title>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi"
    />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script src="../example/dat.gui.min.js"></script>
    <script src="../release/RedGL.min.js"></script>
</head>

<body>
<canvas id="test" style="border: none;background:red"></canvas>
<div id='program' style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;color:#fff">
    testest
</div>
<script>
    var t = document.getElementById('test')
    document.body.appendChild(t)
    RedGL(t, function (v) {
        var tGL;
        var tWorld, tScene3D, tCamera
        var tRenderer;
        var self;
        self = this
        tGL = this.gl;
        this.world = tWorld = RedWorld();
        tScene3D = RedScene(this);
        tCamera = RedObitController(this)
        var testDLight, testALight;
        testDLight = RedDirectionalLight(this, '#fff')
        testALight = RedAmbientLight(this, '#111', 1)
        tScene3D.addLight(testALight)
        tScene3D.addLight(testDLight)
        var testPLight = RedPointLight(this, '#ff0000')
        testPLight.x = -3
        testPLight.y = -3
        testPLight.z = -3
        testPLight['radius'] = 4
        testPLight['intensity'] = 1
        testPLight.debug = true
        tScene3D.addLight(testPLight)
        var testPLight2 = RedPointLight(this, '#00ff00')
        testPLight2.x = -3
        testPLight2.y = -3
        testPLight2.z = -3
        testPLight2['radius'] = 10
        testPLight2['intensity'] = 1
        testPLight2.debug = true
        tScene3D.addLight(testPLight2)
        tRenderer = RedRenderer();
        tWorld.addView(RedView('test', this, tScene3D, tCamera));
        RedView('test').setSize('100%', '100%')
        RedView('test').setLocation('0%', '0%')
        var testMaterial
        var testTextureMap = {
            diffuseTexture: RedBitmapTexture(this, '../asset/brick/Brick03_col.jpg'),
            normalTexture: RedBitmapTexture(this, '../asset/brick/Brick03_nrm.jpg'),
            specularTexture: RedBitmapTexture(this, '../asset/specular.png'),
            displacementTexture: RedBitmapTexture(this, '../asset/displacementTest.jpg')
        }
        testMaterial = RedEnvironmentMaterial(
            this,
            null,
            RedBitmapCubeTexture(this, [
                '../asset/cubemap/SwedishRoyalCastle/px.jpg',
                '../asset/cubemap/SwedishRoyalCastle/nx.jpg',
                '../asset/cubemap/SwedishRoyalCastle/py.jpg',
                '../asset/cubemap/SwedishRoyalCastle/ny.jpg',
                '../asset/cubemap/SwedishRoyalCastle/pz.jpg',
                '../asset/cubemap/SwedishRoyalCastle/nz.jpg'
            ])
        )
        tScene3D.skyBox =
            RedSkyBox(this, [
                '../asset/cubemap/SwedishRoyalCastle/px.jpg',
                '../asset/cubemap/SwedishRoyalCastle/nx.jpg',
                '../asset/cubemap/SwedishRoyalCastle/py.jpg',
                '../asset/cubemap/SwedishRoyalCastle/ny.jpg',
                '../asset/cubemap/SwedishRoyalCastle/pz.jpg',
                '../asset/cubemap/SwedishRoyalCastle/nz.jpg'
            ]);
        JsonModelLoader(this, 'testJsonModel', '../asset/teapot.json', function (interleaveBuffer, indexBuffer) {
            console.log('호잇!', interleaveBuffer, indexBuffer)
            var i = 8500 / 2
            while (i--) {
                var testMesh = RedMesh(self, RedGeometry(interleaveBuffer, indexBuffer), testMaterial)
                testMesh.x = Math.random() * 250 - 125
                testMesh.y = Math.random() * 250 - 125
                testMesh.z = Math.random() * 250 - 125
                testMesh.scaleX = testMesh.scaleY = testMesh.scaleZ = 0.3
                testMesh.rotationX = Math.random() * 360
                testMesh.rotationY = Math.random() * 360
                testMesh.rotationZ = Math.random() * 360
                tScene3D.addChild(testMesh)
                var testMesh = RedMesh(self, RedBox(self), testMaterial)
                testMesh.x = Math.random() * 250 - 125
                testMesh.y = Math.random() * 250 - 125
                testMesh.z = Math.random() * 250 - 125
                testMesh.scaleX = testMesh.scaleY = testMesh.scaleZ = 2.5
                testMesh.rotationX = Math.random() * 360
                testMesh.rotationY = Math.random() * 360
                testMesh.rotationZ = Math.random() * 360
                tScene3D.addChild(testMesh)
            }
//			tScene3D.sortGeometry()
        })
        tRenderer.renderDebuger.visible = true
        var tProgramDom = document.querySelector('#program')
        tRenderer.start(this, function (time) {
            // testInterleaveBuffer.upload(interleaveData)
            var i = tScene3D.children.length
            while (i--) {
                if (i == 0) break
                testMesh = tScene3D.children[i]
                testMesh.rotationX += 0.3
                testMesh.rotationY += 0.3
                testMesh.rotationZ += 0.3
            }
            tProgramDom.innerHTML = '현재프로그램 : ' + (tScene3D['useFog'] ? testMaterial['_programList']['fog'][testMaterial['program']['key']]['key'] : testMaterial['program']['key'])
            testDLight.x = Math.sin(time / 1500) * 10
            testDLight.y = Math.cos(time / 1500) * 10
            testDLight.z = Math.cos(time / 1500) * 10
            testMaterial['displacementPower'] = Math.sin(time / 100)
            // tCamera.z = 20
            // tCamera.lookAt(0, 0, 0)
            testPLight.x = -Math.sin(time / 1500) * 5
            testPLight.y = 2
            testPLight.z = -Math.cos(time / 1500) * 5
            testPLight2.x = Math.sin(time / 1500) * 18.5
            testPLight2.y = 0
            testPLight2.z = Math.cos(time / 1500) * 18.5
        })
        this['gui'] = new dat.GUI({
            name: 'test'
        });
        var testData = {
            state: testMaterial.program.key,
            sprite3DYn: false,
            addSphere500: function () {
                var i = 500
                while (i--) {
                    var testMesh = RedMesh(self, RedSphere(self, 5, 16, 16, 16), testMaterial)
                    testMesh.x = Math.random() * 250 - 125
                    testMesh.y = Math.random() * 250 - 125
                    testMesh.z = Math.random() * 250 - 125
                    testMesh.scaleX = testMesh.scaleY = testMesh.scaleZ = 0.3
                    testMesh.rotationX = Math.random() * 360
                    testMesh.rotationY = Math.random() * 360
                    testMesh.rotationZ = Math.random() * 360
                    tScene3D.addChild(testMesh)
                }
            },
            sortGeometry: function () {
                tScene3D.sortGeometry()
            }
        }
        var t0 = this['gui'].addFolder('autoProgramTest')
        t0.autoPlace = false
        var tList = []
        for (var k in testMaterial._programList['basic']) {
            if (k.indexOf('fog') > -1 || k.indexOf('sprite3D') > -1) continue
            tList.push(testMaterial._programList['basic'][k]['key'].replace('environmentProgram_', ''))
        }
        t0.add(tScene3D, 'useFog', true, false)
        t0.add(testData, 'state', tList).onChange(function (v) {
            v = v.split('_')
            testMaterial.diffuseTexture = null
            testMaterial.normalTexture = null
            testMaterial.displacementTexture = null
            testMaterial.specularTexture = null
            v.forEach(function (k) {
                testMaterial[k] = testTextureMap[k]
            })
            console.log(v)
        })
        t0.add(testData, 'addSphere500')
        t0.add(tScene3D, 'sortGeometry')
        t0.open()
        console.log(tScene3D)
    })
</script>
</body>

</html>